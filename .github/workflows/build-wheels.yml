---
name: üì¶ Build Wheels

on:
  push:
    branches: [main, master]
    tags: ["v*"]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  FORCE_COLOR: "1"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"

jobs:
  build-sdist:
    name: Build source distribution
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0  # Full history for proper versioning
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
      
      - name: Install tox
        run: pip install tox
      
      - name: Build sdist with tox
        run: tox -e build-sdist
      
      - name: Verify sdist
        run: |
          ls -lh dist/*.tar.gz
          tar -tzf dist/*.tar.gz | head -20
      
      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: dist/*.tar.gz
          retention-days: 7

  build-wheels-linux:
    name: Build Linux wheels (${{ matrix.arch }})
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    strategy:
      fail-fast: false
      matrix:
        arch: [x86_64, aarch64]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
      
      - name: Install tox
        run: pip install tox
      
      - name: Set up QEMU for ARM64 emulation
        if: matrix.arch == 'aarch64'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64
      
      - name: Build wheels with tox
        run: |
          if [ "${{ matrix.arch }}" = "x86_64" ]; then
            tox -e build-wheels-linux-x86_64
          else
            tox -e build-wheels-linux-aarch64
          fi
      
      - name: List built wheels
        run: ls -lh dist/*.whl
      
      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-linux-${{ matrix.arch }}
          path: dist/*.whl
          retention-days: 7

  build-wheels-macos:
    name: Build macOS wheels (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    
    strategy:
      fail-fast: false
      matrix:
        os: [macos-13, macos-14]  # macos-13 = x86_64, macos-14 = arm64
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
      
      - name: Set up Python versions
        uses: actions/setup-python@v5
        with:
          python-version: |
            3.10
            3.11
            3.12
            3.13
      
      - name: Install build dependencies
        run: brew install autoconf automake libtool
      
      - name: Install tox
        run: pip install tox
      
      - name: Install delocate (for wheel repair)
        run: pip install delocate
      
      - name: Build wheels with tox
        run: tox -e build-wheels-macos
      
      - name: List built wheels
        run: ls -lh dist/*.whl
      
      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-macos-${{ matrix.os }}
          path: dist/*.whl
          retention-days: 7

  test-wheels:
    name: Test wheel on ${{ matrix.os }} / Python ${{ matrix.python-version }}
    needs: [build-wheels-linux, build-wheels-macos]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-13, macos-14]
        python-version: ["3.10", "3.11", "3.12", "3.13"]
        exclude:
          - os: macos-14
            python-version: "3.10"
    
    steps:
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: dist
          merge-multiple: true
      
      - name: Install wheel
        run: |
          python -m pip install --upgrade pip
          # Find and install the appropriate wheel for this platform/Python
          pip install dist/pyonig-*.whl
      
      - name: Test import
        run: python -c "import pyonig; print(f'pyonig {pyonig.__version__} imported successfully')"
      
      - name: Test basic regex
        run: python -c "from pyonig import compile; p = compile(b'test'); m = p.search(b'this is a test'); print(f'Regex found: {m.group()}')"
      
      - name: Test RegSet
        run: python -c "from pyonig import compile_regset; rs = compile_regset(r'\\d+', r'[a-z]+'); idx, m = rs.search('hello'); print(f'RegSet matched: {m.group()}')"
      
      - name: Test CLI
        run: |
          echo '{"test": "value"}' | pyonig --language json
          pyonig --list-languages

  verify-wheels:
    name: Verify all wheels built
    needs: [build-sdist, build-wheels-linux, build-wheels-macos]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist-all
      
      - name: List all built distributions
        run: |
          echo "=== All built distributions ==="
          find dist-all -type f \( -name "*.whl" -o -name "*.tar.gz" \) -exec ls -lh {} \;
          echo ""
          echo "=== Summary ==="
          echo "Wheels: $(find dist-all -name "*.whl" | wc -l)"
          echo "Sdist: $(find dist-all -name "*.tar.gz" | wc -l)"
      
      - name: Verify wheel count
        run: |
          wheel_count=$(find dist-all -name "*.whl" | wc -l)
          # Expect: 
          # Linux x86_64: 5 wheels (cp310, cp311, cp312, cp313, cp313t)
          # Linux aarch64: 5 wheels
          # macOS x86_64: ~4 wheels (cp310-313)
          # macOS arm64: ~3 wheels (cp311-313, no 3.10)
          # Total: ~17 wheels
          echo "Built $wheel_count wheels"
          if [ "$wheel_count" -lt 15 ]; then
            echo "‚ùå Expected at least 15 wheels, got $wheel_count"
            exit 1
          fi
          echo "‚úì Wheel count looks good"

  status:
    name: ‚úÖ All wheels built and tested
    if: always()
    needs: [build-sdist, build-wheels-linux, build-wheels-macos, test-wheels, verify-wheels]
    runs-on: ubuntu-latest
    timeout-minutes: 1
    
    steps:
      - name: Decide whether all jobs succeeded
        uses: re-actors/alls-green@release/v1
        with:
          jobs: ${{ toJSON(needs) }}

