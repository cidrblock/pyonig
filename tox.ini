[tox]
envlist = py{310,311,312,313}
skip_missing_interpreters = true

[testenv]
# Standard test environment
deps =
    pytest>=7.0.0
    pytest-cov>=4.0.0
commands =
    pytest tests/ --cov=pyonig --cov-report=term-missing -v

[testenv:coverage]
# Full coverage report
deps =
    pytest>=7.0.0
    pytest-cov>=4.0.0
commands =
    pytest tests/ --cov=pyonig --cov-report=term-missing --cov-report=html

[testenv:lint]
# Code quality checks (placeholder for future linters)
skip_install = true
deps =
    ruff
commands =
    ruff check src/ tests/

# ==============================================================================
# Wheel Building Environments (Portable, CI-Agnostic)
# ==============================================================================

[testenv:build-sdist]
# Build source distribution
skip_install = true
deps =
    build
commands =
    python -m build --sdist --outdir {toxinidir}/dist

[testenv:build-wheels-linux-x86_64]
# Build manylinux wheels for x86_64
# Requires: Docker or Podman
skip_install = true
allowlist_externals =
    docker
    bash
commands =
    bash -c "docker run --rm \
        -v {toxinidir}:/io:Z \
        -e PLAT=manylinux2014_x86_64 \
        quay.io/pypa/manylinux2014_x86_64 \
        /io/build-scripts/build-linux-wheels.sh"

[testenv:build-wheels-linux-aarch64]
# Build manylinux wheels for ARM64/aarch64
# Requires: Docker or Podman with QEMU (for emulation on x86_64)
skip_install = true
allowlist_externals =
    docker
    bash
commands =
    bash -c "docker run --rm \
        -v {toxinidir}:/io:Z \
        --platform linux/arm64 \
        -e PLAT=manylinux2014_aarch64 \
        quay.io/pypa/manylinux2014_aarch64 \
        /io/build-scripts/build-linux-wheels.sh"

[testenv:build-wheels-linux-all]
# Build all Linux wheels (x86_64 + aarch64)
skip_install = true
allowlist_externals =
    docker
    bash
commands =
    # x86_64
    bash -c "docker run --rm \
        -v {toxinidir}:/io:Z \
        -e PLAT=manylinux2014_x86_64 \
        quay.io/pypa/manylinux2014_x86_64 \
        /io/build-scripts/build-linux-wheels.sh"
    # aarch64
    bash -c "docker run --rm \
        -v {toxinidir}:/io:Z \
        --platform linux/arm64 \
        -e PLAT=manylinux2014_aarch64 \
        quay.io/pypa/manylinux2014_aarch64 \
        /io/build-scripts/build-linux-wheels.sh"

[testenv:build-wheels-macos]
# Build macOS wheels (native, no container needed)
# Runs on macOS only
platform = darwin
skip_install = true
allowlist_externals = bash
commands =
    bash {toxinidir}/build-scripts/build-macos-wheels.sh

[testenv:build-wheels-all]
# Build all wheels: Linux (x86_64 + aarch64) + macOS (if on macOS)
# This is the main entry point for wheel building
skip_install = true
allowlist_externals =
    docker
    bash
    uname
commands =
    # Always build Linux wheels (in containers)
    bash -c "docker run --rm \
        -v {toxinidir}:/io:Z \
        -e PLAT=manylinux2014_x86_64 \
        quay.io/pypa/manylinux2014_x86_64 \
        /io/build-scripts/build-linux-wheels.sh"
    bash -c "docker run --rm \
        -v {toxinidir}:/io:Z \
        --platform linux/arm64 \
        -e PLAT=manylinux2014_aarch64 \
        quay.io/pypa/manylinux2014_aarch64 \
        /io/build-scripts/build-linux-wheels.sh"
    # Build macOS wheels if on macOS
    bash -c "if [[ $(uname) == 'Darwin' ]]; then \
        {toxinidir}/build-scripts/build-macos-wheels.sh; \
    else \
        echo 'Skipping macOS wheels (not on macOS)'; \
    fi"

# ==============================================================================
# Publishing Environments
# ==============================================================================

[testenv:publish-test]
# Publish to TestPyPI
skip_install = true
deps = twine
passenv = TWINE_*
commands =
    twine check dist/*
    twine upload --repository testpypi dist/*

[testenv:publish]
# Publish to PyPI (production)
skip_install = true
deps = twine
passenv = TWINE_*
commands =
    twine check dist/*
    twine upload dist/*

# ==============================================================================
# Development Environments
# ==============================================================================

[testenv:dev]
# Development environment with all tools
usedevelop = true
deps =
    pytest>=7.0.0
    pytest-cov>=4.0.0
    ruff
    twine
    build
commands =
    python -c "print('Development environment ready. Run: pytest tests/')"

